#!/bin/bash -ex

WEBROOT=/var/www/rails

# update Gemfile
cat >> $WEBROOT/Gemfile<<EOF
gem 'execjs'
gem 'therubyracer'
EOF

cd $WEBROOT
bundle install --local

# generate controller
rails generate controller cp

# apply railsapp webcp overlay
cp -TdR $WEBROOT.overlay $WEBROOT
rm -rf $WEBROOT.overlay

# set asset compilation on-demand
sed -i "/config.assets.compile/ s/false/true/" $WEBROOT/config/environments/production.rb

# configure tkl-webcp
rm /var/www/js/jquery-*.js
sed -i "s|../images/||" /var/www/css/ui.tabs.css

cp -a /var/www/js/* $WEBROOT/app/assets/javascripts/
cp -a /var/www/css/* $WEBROOT/app/assets/stylesheets/
cp -a /var/www/images/* $WEBROOT/app/assets/images/

rm -rf /var/www/{js,css,images}

# remove default index
rm -f $WEBROOT/public/index.html

